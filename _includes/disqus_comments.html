{% if page.comments != false and jekyll.environment == "production" %}

  <div id="disqus_thread"></div>
  <!-- Dynamic Disqus reloader that forces fresh iframe creation on theme changes -->
  <script>
    (function () {
      // keep original url / identifier handy
      const disqusCfg = {
        url:  '{{ page.url | absolute_url }}',
        id:   '{{ page.url | absolute_url }}'
      };

      // helper to (re)load Disqus
      function embedDisqus(theme) {
        const container = document.getElementById('disqus_thread');
        if (!container) return;

        // 1. wipe any previous embed
        container.innerHTML = '';
        delete window.DISQUS;
        Array.from(document.querySelectorAll('script[src*="disqus.com/embed.js"]'))
             .forEach(s => s.parentNode.removeChild(s));

        // 2. global config for the upcoming load
        window.disqus_config = function () {
          this.page.url        = disqusCfg.url;
          this.page.identifier = disqusCfg.id;
          this.page.theme      = theme;          // force scheme
        };

        // 3. inject fresh script (unique query param busts caching)
        const s = document.createElement('script');
        s.src = 'https://{{ site.disqus.shortname }}.disqus.com/embed.js?ts=' + Date.now();
        s.setAttribute('data-timestamp', Date.now());
        (document.head || document.body).appendChild(s);
      }

      /* first load â€” use current data-theme */
      embedDisqus(document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark');

      /* reload whenever our site theme changes */
      window.addEventListener('themeChanged', e => {
        console.log('Disqus: themeChanged event received', e.detail);
        const theme = e.detail && e.detail.theme ? e.detail.theme :
                      (document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark');
        console.log('Disqus: reloading with theme', theme);
        embedDisqus(theme);
      });

    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
{% endif %}